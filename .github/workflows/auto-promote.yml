name: Auto Promote (Event-Driven)

on:
  repository_dispatch:
    types: [image-published]
  workflow_dispatch:
    inputs:
      backend_ref:
        description: "(å¯é€‰) åŽç«¯é•œåƒ refï¼Œç•™ç©ºè‡ªåŠ¨èŽ·å–æœ€æ–°"
        required: false
        type: string
      frontend_ref:
        description: "(å¯é€‰) å‰ç«¯é•œåƒ refï¼Œç•™ç©ºè‡ªåŠ¨èŽ·å–æœ€æ–°"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  packages: read

concurrency:
  group: promote-rc
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  OWNER: 1zero224
  RC_BRANCH: promote/rc
  RC_PR_TITLE: "Release Candidate"

jobs:
  promote:
    name: Update Release Candidate PR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log trigger source
        run: |
          echo "### Trigger Info" >> "$GITHUB_STEP_SUMMARY"
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "- **Event**: repository_dispatch (image-published)" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Service**: ${{ github.event.client_payload.service }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Image Ref**: \`${{ github.event.client_payload.ref }}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Source Repo**: ${{ github.event.client_payload.repo }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Source SHA**: ${{ github.event.client_payload.sha }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Event**: workflow_dispatch (manual)" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Fetch latest image digests
        id: fetch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          get_latest_digest() {
            local package=$1
            local tag=${2:-main}

            gh api \
              -H "Accept: application/vnd.github+json" \
              "/users/${{ env.OWNER }}/packages/container/${package}/versions" \
              --jq "[.[] | select(.metadata.container.tags | index(\"${tag}\"))] | .[0].name" \
            | head -1
          }

          # Backend
          if [[ -n "${{ inputs.backend_ref }}" ]]; then
            BACKEND_REF="${{ inputs.backend_ref }}"
            echo "Using user-provided backend ref"
          else
            DIGEST=$(get_latest_digest "biliboard-backend" "main")
            BACKEND_REF="${{ env.REGISTRY }}/${{ env.OWNER }}/biliboard-backend:main@${DIGEST}"
            echo "Auto-fetched backend ref"
          fi

          # Frontend
          if [[ -n "${{ inputs.frontend_ref }}" ]]; then
            FRONTEND_REF="${{ inputs.frontend_ref }}"
            echo "Using user-provided frontend ref"
          else
            DIGEST=$(get_latest_digest "biliboard-frontend" "main")
            FRONTEND_REF="${{ env.REGISTRY }}/${{ env.OWNER }}/biliboard-frontend:main@${DIGEST}"
            echo "Auto-fetched frontend ref"
          fi

          echo "backend_ref=${BACKEND_REF}" >> "$GITHUB_OUTPUT"
          echo "frontend_ref=${FRONTEND_REF}" >> "$GITHUB_OUTPUT"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ðŸ“¦ Image References" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Backend**: \`${BACKEND_REF}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Frontend**: \`${FRONTEND_REF}\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Validate refs
        shell: bash
        run: |
          set -euo pipefail
          for ref in "${{ steps.fetch.outputs.backend_ref }}" "${{ steps.fetch.outputs.frontend_ref }}"; do
            if [[ "$ref" != ghcr.io/*@sha256:* ]]; then
              echo "::error::Invalid image ref (must include @sha256:): $ref"
              exit 1
            fi
          done

      - name: Check for changes
        id: check-changes
        shell: bash
        run: |
          set -euo pipefail

          CURRENT_BACKEND=$(grep '^BACKEND_REF=' .env.versions | cut -d= -f2- || echo "")
          CURRENT_FRONTEND=$(grep '^FRONTEND_REF=' .env.versions | cut -d= -f2- || echo "")

          NEW_BACKEND="${{ steps.fetch.outputs.backend_ref }}"
          NEW_FRONTEND="${{ steps.fetch.outputs.frontend_ref }}"

          if [[ "$CURRENT_BACKEND" == "$NEW_BACKEND" && "$CURRENT_FRONTEND" == "$NEW_FRONTEND" ]]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No changes detected, skipping PR update"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"

            CHANGES=""
            [[ "$CURRENT_BACKEND" != "$NEW_BACKEND" ]] && CHANGES="${CHANGES}- Backend updated\n"
            [[ "$CURRENT_FRONTEND" != "$NEW_FRONTEND" ]] && CHANGES="${CHANGES}- Frontend updated\n"
            echo -e "changes_summary<<EOF\n${CHANGES}EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup RC branch
        if: steps.check-changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if RC branch exists on remote
          if git ls-remote --exit-code origin "${{ env.RC_BRANCH }}" >/dev/null 2>&1; then
            echo "RC branch exists, checking out"
            git fetch origin "${{ env.RC_BRANCH }}"
            git checkout "${{ env.RC_BRANCH }}"
            git reset --hard origin/master
          else
            echo "RC branch does not exist, creating from master"
            git checkout -b "${{ env.RC_BRANCH }}"
          fi

      - name: Update backend ref
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: ./.github/actions/update-env-versions
        with:
          file: .env.versions
          key: BACKEND_REF
          value: ${{ steps.fetch.outputs.backend_ref }}

      - name: Update frontend ref
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: ./.github/actions/update-env-versions
        with:
          file: .env.versions
          key: FRONTEND_REF
          value: ${{ steps.fetch.outputs.frontend_ref }}

      - name: Commit and push
        if: steps.check-changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail

          git add .env.versions

          # Build commit message with trigger info
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            TRIGGER_INFO="Triggered by ${{ github.event.client_payload.service }} CI (${{ github.event.client_payload.sha }})"
          else
            TRIGGER_INFO="Triggered manually"
          fi

          git commit -m "chore: update image refs

          ${TRIGGER_INFO}

          Backend: ${{ steps.fetch.outputs.backend_ref }}
          Frontend: ${{ steps.fetch.outputs.frontend_ref }}"

          git push -f origin "${{ env.RC_BRANCH }}"

      - name: Check existing PR
        if: steps.check-changes.outputs.has_changes == 'true'
        id: pr-check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          PR_NUMBER=$(gh pr list \
            --head "${{ env.RC_BRANCH }}" \
            --base master \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [[ -n "$PR_NUMBER" ]]; then
            echo "pr_exists=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "::notice::Existing PR #${PR_NUMBER} will be updated"
          else
            echo "pr_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR
        if: steps.check-changes.outputs.has_changes == 'true' && steps.pr-check.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          PR_URL=$(gh pr create \
            --title "${{ env.RC_PR_TITLE }}" \
            --body "$(cat <<'EOF'
          ## Release Candidate

          This PR aggregates image updates from CI pipelines.

          ### Current Image References
          - **Backend**: `${{ steps.fetch.outputs.backend_ref }}`
          - **Frontend**: `${{ steps.fetch.outputs.frontend_ref }}`

          ### How it works
          - Each CI build triggers an update to this PR
          - Multiple updates are aggregated into a single PR
          - Merge when ready to deploy to production

          ---
          âš ï¸ **After merge**, the Deploy workflow will run on the production runner with environment protection.
          EOF
          )" \
            --head "${{ env.RC_BRANCH }}" \
            --base master)

          echo "### âœ… PR Created" >> "$GITHUB_STEP_SUMMARY"
          echo "- **URL**: ${PR_URL}" >> "$GITHUB_STEP_SUMMARY"

      - name: Update PR body
        if: steps.check-changes.outputs.has_changes == 'true' && steps.pr-check.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BACKEND_REF: ${{ steps.fetch.outputs.backend_ref }}
          FRONTEND_REF: ${{ steps.fetch.outputs.frontend_ref }}
        shell: bash
        run: |
          set -euo pipefail

          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          cat > /tmp/pr-body.md <<EOF
## Release Candidate

This PR aggregates image updates from CI pipelines.

### Current Image References
- **Backend**: \`${BACKEND_REF}\`
- **Frontend**: \`${FRONTEND_REF}\`

### How it works
- Each CI build triggers an update to this PR
- Multiple updates are aggregated into a single PR
- Merge when ready to deploy to production

---
âš ï¸ **After merge**, the Deploy workflow will run on the production runner with environment protection.

_Last updated: ${TIMESTAMP}_
EOF

          gh pr edit "${{ steps.pr-check.outputs.pr_number }}" --body-file /tmp/pr-body.md

          # Add comment for audit trail
          gh pr comment "${{ steps.pr-check.outputs.pr_number }}" \
            --body "ðŸ”„ **Updated** by ${{ github.event_name }} event

          ${{ steps.check-changes.outputs.changes_summary }}
          - Backend: \`${{ steps.fetch.outputs.backend_ref }}\`
          - Frontend: \`${{ steps.fetch.outputs.frontend_ref }}\`"

          echo "### âœ… PR Updated" >> "$GITHUB_STEP_SUMMARY"
          echo "- **PR**: #${{ steps.pr-check.outputs.pr_number }}" >> "$GITHUB_STEP_SUMMARY"

      - name: No changes summary
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "### â„¹ï¸ No Changes" >> "$GITHUB_STEP_SUMMARY"
          echo "Current .env.versions already has the latest image refs." >> "$GITHUB_STEP_SUMMARY"
