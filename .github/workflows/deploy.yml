name: Deploy

on:
  push:
    branches: [master]
    paths:
      - '.env.versions'
      - 'docker-compose.yml'
      - 'nginx/**'
      - 'prometheus/**'
      - 'grafana/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  deployments: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production (self-hosted runner)
    runs-on: [self-hosted, biliboard-prod]
    environment: production
    env:
      COMPOSE_PROJECT_NAME: biliboard

    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: [],
              description: 'Deploying to production server'
            });
            return deployment.data.id;
          result-encoding: string

      - name: Update Deployment Status (in_progress)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'in_progress',
              description: 'Deployment started on production runner'
            });

      - name: Load image refs from .env.versions
        shell: bash
        run: |
          set -euo pipefail

          declare -A found_keys

          while IFS='=' read -r key value; do
            [[ "$key" =~ ^#.*$ || -z "${key// /}" ]] && continue

            key="$(echo "$key" | xargs)"
            value="$(echo "$value" | xargs)"

            case "$key" in
              BACKEND_REF|FRONTEND_REF)
                if [[ ! "$value" =~ ^ghcr\.io/[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+:[A-Za-z0-9_.-]+@sha256:[0-9a-f]{64}$ ]]; then
                  echo "Invalid $key: $value" >&2
                  exit 1
                fi
                echo "$key=$value" >> "$GITHUB_ENV"
                found_keys["$key"]=1
                ;;
            esac
          done < .env.versions

          if [[ -z "${found_keys[BACKEND_REF]:-}" || -z "${found_keys[FRONTEND_REF]:-}" ]]; then
            echo "Missing BACKEND_REF or FRONTEND_REF in .env.versions" >&2
            exit 1
          fi

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull images
        shell: bash
        run: |
          set -euo pipefail
          docker compose pull

      - name: Stop existing containers
        shell: bash
        run: |
          set -euo pipefail
          docker compose down --remove-orphans || true

      - name: Cleanup conflicting containers
        shell: bash
        run: |
          set -euo pipefail
          for name in biliboard-backend biliboard-frontend biliboard-prometheus \
                      biliboard-grafana biliboard-node-exporter; do
            docker rm -f "$name" 2>/dev/null || true
          done

      - name: Apply update
        shell: bash
        run: |
          set -euo pipefail
          docker compose up -d --remove-orphans

      - name: Health check
        shell: bash
        run: |
          set -euo pipefail

          http_port="${HTTP_PORT:-80}"
          max_retries=12
          retry_interval=5

          echo "Checking http://127.0.0.1:${http_port}/health ..."
          for ((i=1; i<=max_retries; i++)); do
            if curl -sf "http://127.0.0.1:${http_port}/health" >/dev/null 2>&1; then
              echo "Health check OK"
              exit 0
            fi
            echo "Health check failed ($i/$max_retries), retrying..."
            sleep "$retry_interval"
          done

          echo "Health check failed after ${max_retries} attempts" >&2
          exit 1

      - name: Update Deployment Status (success)
        if: success() && steps.deployment.outputs.result != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'success',
              description: 'Deployment completed successfully'
            });

      - name: Update Deployment Status (failure)
        if: failure() && steps.deployment.outputs.result != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'failure',
              description: 'Deployment failed'
            });
